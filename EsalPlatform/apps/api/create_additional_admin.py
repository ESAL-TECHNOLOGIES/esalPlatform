#!/usr/bin/env python3
"""
Additional Admin User Creation Script
This script creates additional admin users for the ESAL Platform admin portal.
"""
import asyncio
import sys
import os
import logging
from datetime import datetime, timezone

# Add the app directory to Python path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'app'))

from app.config import settings
from supabase import create_client, Client

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

async def create_additional_admin_user(email: str, password: str, full_name: str, username: str):
    """Create an additional admin user for the admin portal with full system authentication"""
    try:
        print(f"üîê Creating Admin User: {email}")
        print("=" * 50)
        
        # Use service role key to access Supabase admin functions
        supabase_client = create_client(settings.SUPABASE_URL, settings.SUPABASE_SERVICE_ROLE_KEY)
        
        print(f"üìß Admin Email: {email}")
        print(f"üë§ Full Name: {full_name}")
        print(f"üè∑Ô∏è  Username: {username}")
        print(f"üîë Password: {'*' * len(password)}")
        print()
        
        # Check if admin user already exists by trying to get user by email
        print("üîç Checking if user already exists...")
        try:
            # Use admin API to list users and find by email
            users_response = supabase_client.auth.admin.list_users()
            existing_user = None
            
            if users_response.data:
                for user in users_response.data:
                    if user.email == email:
                        existing_user = user
                        break
            
            if existing_user:
                print("‚ö†Ô∏è  Admin user already exists!")
                user_id = existing_user.id
                print(f"   User ID: {user_id}")
                print(f"   Email: {existing_user.email}")
                print(f"   Created: {existing_user.created_at}")
                
                print("üîÑ Updating existing user to admin with full permissions...")
                # Update their role to admin with comprehensive metadata
                update_response = supabase_client.auth.admin.update_user_by_id(
                    user_id,
                    {
                        "user_metadata": {
                            "role": "admin",
                            "full_name": full_name,
                            "username": username,
                            "is_active": True,
                            "is_blocked": False,
                            "permissions": [
                                "admin.read",
                                "admin.write", 
                                "admin.delete",
                                "users.manage",
                                "system.configure",
                                "reports.view",
                                "analytics.access"
                            ],
                            "admin_level": "super_admin",
                            "created_by": "system",
                            "last_updated": datetime.now(timezone.utc).isoformat()
                        },
                        "app_metadata": {
                            "role": "admin",
                            "admin": True,
                            "provider": "email"
                        }
                    }
                )
                
                if update_response.user:
                    print("‚úÖ Updated existing user to admin role with full permissions")
                    
                    # Try to update/create profile as well
                    try:
                        print("üîÑ Creating/updating admin profile...")
                        admin_profile = {
                            "id": user_id,
                            "full_name": full_name,
                            "username": username,
                            "email": email,
                            "bio": f"ESAL Platform Administrator - {full_name}",
                            "role": "admin",
                            "is_active": True,
                            "permissions": [
                                "admin.read",
                                "admin.write", 
                                "admin.delete",
                                "users.manage",
                                "system.configure"
                            ],
                            "updated_at": datetime.now(timezone.utc).isoformat()
                        }
                        
                        # Try to upsert (insert or update) the profile
                        profile_result = supabase_client.table("profiles").upsert(admin_profile).execute()
                        
                        if profile_result.data:
                            print("‚úÖ Updated admin profile in profiles table")
                        else:
                            print("‚ö†Ô∏è  Could not update profile")
                            
                    except Exception as profile_error:
                        print(f"‚ö†Ô∏è  Profile update failed: {profile_error}")
                    
                    # Create admin-specific records if needed
                    await create_admin_system_records(supabase_client, user_id, email, full_name, username)
                    
                    print()
                    print("üéâ EXISTING ADMIN USER UPDATED SUCCESSFULLY!")
                    print("=" * 50)
                    print("Admin Portal Login Details:")
                    print(f"   Email:    {email}")
                    print(f"   Role:     super_admin")
                    print(f"   User ID:  {user_id}")
                    print("üöÄ Admin portal access:")
                    print("   http://localhost:3004/login")
                    print()
                    print("‚ö†Ô∏è  IMPORTANT: Use the existing password or reset if needed!")
                    
                    return user_id
                else:
                    print("‚ö†Ô∏è  Could not update existing user role")
                    return user_id  # Still return the user ID as they exist
                    
        except Exception as e:
            print(f"‚ÑπÔ∏è  Error checking for existing user: {e}")
            print("üîÑ Proceeding to create new user...")
        
        print("üÜï Creating new admin user with full system authentication...")
        
        # Create admin user through Supabase Admin API with comprehensive setup
        auth_response = supabase_client.auth.admin.create_user({
            "email": email,
            "password": password,
            "email_confirm": True,  # Auto-confirm email for admin
            "user_metadata": {
                "role": "admin",
                "full_name": full_name,
                "username": username,
                "is_active": True,
                "is_blocked": False,
                "permissions": [
                    "admin.read",
                    "admin.write", 
                    "admin.delete",
                    "users.manage",
                    "system.configure",
                    "reports.view",
                    "analytics.access"
                ],
                "admin_level": "super_admin",
                "created_by": "system",
                "created_at": datetime.now(timezone.utc).isoformat()
            },
            "app_metadata": {
                "role": "admin",
                "admin": True,
                "provider": "email"
            }
        })
        
        if auth_response.user:
            user_id = auth_response.user.id
            print(f"‚úÖ Created admin user with ID: {user_id}")
            
            # Create corresponding profile in profiles table
            try:
                print("üîÑ Creating admin profile...")
                admin_profile = {
                    "id": user_id,
                    "full_name": full_name,
                    "username": username,
                    "email": email,
                    "bio": f"ESAL Platform Administrator - {full_name}",
                    "role": "admin",
                    "is_active": True,
                    "permissions": [
                        "admin.read",
                        "admin.write", 
                        "admin.delete",
                        "users.manage",
                        "system.configure"
                    ],
                    "created_at": datetime.now(timezone.utc).isoformat(),
                    "updated_at": datetime.now(timezone.utc).isoformat()
                }
                
                profile_result = supabase_client.table("profiles").insert(admin_profile).execute()
                
                if profile_result.data:
                    print("‚úÖ Created admin profile in profiles table")
                else:
                    print("‚ö†Ô∏è  Admin user created but profile creation failed")
                    
            except Exception as profile_error:
                print(f"‚ö†Ô∏è  Could not create profile: {profile_error}")
            
            # Create admin-specific system records
            await create_admin_system_records(supabase_client, user_id, email, full_name, username)
            
            print()
            print("üéâ ADMIN USER CREATED SUCCESSFULLY!")
            print("=" * 50)
            print("Admin Portal Login Details:")
            print(f"   Email:    {email}")
            print(f"   Password: {password}")
            print(f"   Role:     super_admin")
            print(f"   User ID:  {user_id}")
            print("üöÄ Admin portal access:")
            print("   http://localhost:3004/login")
            print()
            print("‚úÖ Full system authentication configured")
            print("‚ö†Ô∏è  IMPORTANT: Change the default password after first login!")
            
            return user_id
            
        else:
            print("‚ùå Failed to create admin user")
            return None
            
    except Exception as e:
        print(f"‚ùå Error creating admin user: {str(e)}")
        import traceback
        traceback.print_exc()
        return None

async def create_admin_system_records(supabase_client, user_id: str, email: str, full_name: str, username: str):
    """Create additional system records for admin user"""
    try:
        print("üîÑ Setting up additional admin system records...")
        
        # Create admin session record (if admin_sessions table exists)
        try:
            admin_session = {
                "user_id": user_id,
                "email": email,
                "role": "admin",
                "permissions": [
                    "admin.read",
                    "admin.write", 
                    "admin.delete",
                    "users.manage",
                    "system.configure"
                ],
                "last_login": None,
                "is_active": True,
                "created_at": datetime.now(timezone.utc).isoformat()
            }
            
            # Try to create admin session record
            session_result = supabase_client.table("admin_sessions").upsert(admin_session).execute()
            if session_result.data:
                print("‚úÖ Created admin session record")
                
        except Exception as session_error:
            print(f"‚ÑπÔ∏è  Admin session table may not exist: {session_error}")
        
        # Create admin permissions record (if admin_permissions table exists)
        try:
            admin_permissions = {
                "user_id": user_id,
                "email": email,
                "permissions": {
                    "dashboard": True,
                    "users": True,
                    "analytics": True,
                    "settings": True,
                    "reports": True,
                    "system": True
                },
                "admin_level": "super_admin",
                "created_at": datetime.now(timezone.utc).isoformat()
            }
            
            permission_result = supabase_client.table("admin_permissions").upsert(admin_permissions).execute()
            if permission_result.data:
                print("‚úÖ Created admin permissions record")
                
        except Exception as perm_error:
            print(f"‚ÑπÔ∏è  Admin permissions table may not exist: {perm_error}")
        
        print("‚úÖ Admin system records setup completed")
        
    except Exception as e:
        print(f"‚ö†Ô∏è  Error creating admin system records: {e}")
        # This is not critical, so we don't fail the entire process

async def test_admin_login(email: str, password: str):
    """Test that the admin user can log in with full system authentication"""
    try:
        print(f"\nüß™ Testing Full System Authentication for {email}...")
        print("=" * 50)
        
        # Import auth service to test login
        from app.services.auth_supabase import SupabaseAuthService
        from app.schemas import UserLogin
        
        auth_service = SupabaseAuthService()
        
        # Test login
        login_data = UserLogin(
            email=email,
            password=password
        )
        
        print("üîÑ Attempting login...")
        result = await auth_service.login(login_data)
        
        if result and result.user.role == "admin":
            print("‚úÖ Admin authentication successful!")
            print(f"   ‚úÖ Access Token Generated: {result.access_token[:50]}...")
            print(f"   ‚úÖ User Role Verified: {result.user.role}")
            print(f"   ‚úÖ User ID: {result.user.id}")
            print(f"   ‚úÖ Email Verified: {result.user.email}")
            
            # Test admin permissions
            if hasattr(result.user, 'permissions'):
                print(f"   ‚úÖ Permissions: {len(result.user.permissions)} permission(s)")
            
            print()
            print("üîê Full System Authentication Test: PASSED")
            print("   ‚Ä¢ User can authenticate with email/password")
            print("   ‚Ä¢ Admin role is properly assigned")
            print("   ‚Ä¢ Access tokens are generated correctly")
            print("   ‚Ä¢ User metadata is accessible")
            
            return True
        elif result:
            print("‚ùå Admin authentication failed - incorrect role")
            print(f"   Expected role: admin")
            print(f"   Actual role: {result.user.role}")
            return False
        else:
            print("‚ùå Admin authentication failed - login unsuccessful")
            return False
            
    except Exception as e:
        print(f"‚ùå Admin authentication test error: {e}")
        print("   This could indicate:")
        print("   ‚Ä¢ Authentication service configuration issues")
        print("   ‚Ä¢ Database connection problems")
        print("   ‚Ä¢ Missing dependencies")
        import traceback
        traceback.print_exc()
        return False

async def create_multiple_admins():
    """Create multiple admin users"""
    print("üèóÔ∏è  ESAL Platform Additional Admin Users Setup")
    print("=" * 60)
    
    # Check environment
    if not settings.SUPABASE_URL or not settings.SUPABASE_SERVICE_ROLE_KEY:
        print("‚ùå Error: Missing Supabase configuration")
        print("   Please ensure SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in your .env file")
        return False
    
    print(f"üîó Supabase URL: {settings.SUPABASE_URL}")
    print(f"üîë Service Key: {settings.SUPABASE_SERVICE_ROLE_KEY[:20]}...")
    print()
    
    # Define additional admin users to create
    admin_users = [
        {
            "email": "admin@esal.platform",
            "password": "AdminSecure123!",
            "full_name": "System Administrator", 
            "username": "sysadmin"
        },
        {
            "email": "manager@esal.platform",
            "password": "ManagerSecure123!",
            "full_name": "Platform Manager",
            "username": "manager"
        },
        {
            "email": "super@esal.platform", 
            "password": "SuperSecure123!",
            "full_name": "Super Administrator",
            "username": "superadmin"
        }
    ]
    
    created_users = []
    
    for admin_data in admin_users:
        print(f"\n{'='*60}")
        user_id = await create_additional_admin_user(
            email=admin_data["email"],
            password=admin_data["password"], 
            full_name=admin_data["full_name"],
            username=admin_data["username"]
        )
        
        if user_id:
            # Test login
            login_success = await test_admin_login(
                email=admin_data["email"],
                password=admin_data["password"]
            )
            
            created_users.append({
                "user_id": user_id,
                "email": admin_data["email"],
                "login_success": login_success,
                "full_name": admin_data["full_name"]
            })
        
        print(f"{'='*60}")
    
    # Summary
    print(f"\nüéâ ADMIN USERS SETUP SUMMARY")
    print("=" * 60)
    
    if created_users:
        print(f"‚úÖ Successfully processed {len(created_users)} admin users:")
        for user in created_users:
            status = "‚úÖ Login OK" if user["login_success"] else "‚ö†Ô∏è  Login Failed"
            print(f"   ‚Ä¢ {user['full_name']} ({user['email']}) - {status}")
        
        print("\nüöÄ All admin users can now log into the admin portal at:")
        print("   http://localhost:3004/login")
        print("\n‚ö†Ô∏è  IMPORTANT: Change default passwords after first login!")
        return True
    else:
        print("‚ùå No admin users were successfully created")
        return False

def validate_email(email: str) -> bool:
    """Validate email format"""
    import re
    pattern = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    return re.match(pattern, email) is not None

def validate_password(password: str) -> tuple[bool, str]:
    """Validate password strength"""
    if len(password) < 8:
        return False, "Password must be at least 8 characters long"
    
    if not any(c.isupper() for c in password):
        return False, "Password must contain at least one uppercase letter"
    
    if not any(c.islower() for c in password):
        return False, "Password must contain at least one lowercase letter"
    
    if not any(c.isdigit() for c in password):
        return False, "Password must contain at least one number"
    
    special_chars = "!@#$%^&*()_+-=[]{}|;:,.<>?"
    if not any(c in special_chars for c in password):
        return False, "Password must contain at least one special character"
    
    return True, "Password is strong"

def validate_username(username: str) -> tuple[bool, str]:
    """Validate username format"""
    if len(username) < 3:
        return False, "Username must be at least 3 characters long"
    
    if len(username) > 20:
        return False, "Username must be no more than 20 characters long"
    
    if not username.replace('_', '').replace('-', '').isalnum():
        return False, "Username can only contain letters, numbers, hyphens, and underscores"
    
    if username.startswith(('-', '_')) or username.endswith(('-', '_')):
        return False, "Username cannot start or end with hyphens or underscores"
    
    return True, "Username is valid"

def get_user_input_with_validation():
    """Get user input with validation"""
    print("üèóÔ∏è  ESAL Platform Admin User Creation")
    print("=" * 50)
    print("Please provide the following details for the new admin user:")
    print()
    
    # Get and validate email
    while True:
        email = input("üìß Email address: ").strip().lower()
        if not email:
            print("‚ùå Email is required!")
            continue
        
        if not validate_email(email):
            print("‚ùå Please enter a valid email address!")
            continue
        
        print(f"‚úÖ Email: {email}")
        break
    
    # Get and validate full name
    while True:
        full_name = input("üë§ Full name: ").strip()
        if not full_name:
            print("‚ùå Full name is required!")
            continue
        
        if len(full_name) < 2:
            print("‚ùå Full name must be at least 2 characters long!")
            continue
        
        print(f"‚úÖ Full name: {full_name}")
        break
    
    # Get and validate username
    while True:
        username = input("üè∑Ô∏è  Username: ").strip().lower()
        if not username:
            print("‚ùå Username is required!")
            continue
        
        is_valid, message = validate_username(username)
        if not is_valid:
            print(f"‚ùå {message}")
            continue
        
        print(f"‚úÖ Username: {username}")
        break
    
    # Get and validate password
    while True:
        print("\nüîë Password Requirements:")
        print("   ‚Ä¢ At least 8 characters long")
        print("   ‚Ä¢ Contains uppercase and lowercase letters")
        print("   ‚Ä¢ Contains at least one number")
        print("   ‚Ä¢ Contains at least one special character (!@#$%^&*etc.)")
        print()
        
        password = input("üîë Password: ").strip()
        if not password:
            print("‚ùå Password is required!")
            continue
        
        is_valid, message = validate_password(password)
        if not is_valid:
            print(f"‚ùå {message}")
            continue
        
        # Confirm password
        confirm_password = input("üîë Confirm password: ").strip()
        if password != confirm_password:
            print("‚ùå Passwords do not match!")
            continue
        
        print("‚úÖ Password validated successfully")
        break
    
    # Show summary and confirm
    print("\n" + "=" * 50)
    print("üìã ADMIN USER SUMMARY")
    print("=" * 50)
    print(f"üìß Email:     {email}")
    print(f"üë§ Full Name: {full_name}")
    print(f"üè∑Ô∏è  Username:  {username}")
    print(f"üîë Password:  {'*' * len(password)}")
    print()
    
    while True:
        confirm = input("‚úÖ Create this admin user? (y/n): ").strip().lower()
        if confirm in ['y', 'yes']:
            return email, full_name, username, password
        elif confirm in ['n', 'no']:
            print("‚ùå Admin user creation cancelled.")
            return None, None, None, None
        else:
            print("‚ùå Please enter 'y' for yes or 'n' for no")

async def create_single_admin():
    """Create a single admin user with user input and validation"""
    print("üèóÔ∏è  ESAL Platform Single Admin User Setup")
    print("=" * 50)
    
    # Check environment
    if not settings.SUPABASE_URL or not settings.SUPABASE_SERVICE_ROLE_KEY:
        print("‚ùå Error: Missing Supabase configuration")
        print("   Please ensure SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY are set in your .env file")
        return False
    
    print(f"üîó Connected to: {settings.SUPABASE_URL}")
    print(f"üîë Using service key: {settings.SUPABASE_SERVICE_ROLE_KEY[:20]}...")
    print()
    
    # Get user input with validation
    email, full_name, username, password = get_user_input_with_validation()
    
    if not all([email, full_name, username, password]):
        return False
    
    print("\nüöÄ Creating admin user...")
    
    # Create the admin user
    user_id = await create_additional_admin_user(
        email=email,
        password=password,
        full_name=full_name,
        username=username
    )
    
    if user_id:
        # Test login
        login_success = await test_admin_login(email, password)
        
        if login_success:
            print("\nüéâ SETUP COMPLETE!")
            print("The admin user is ready for use with full system authentication.")
            print("\nüìù Login Instructions:")
            print("   1. Go to http://localhost:3004/login")
            print("   2. Use the email and password you just created")
            print("   3. You will have full admin access to the platform")
            print()
            print("‚ö†Ô∏è  SECURITY REMINDER:")
            print("   ‚Ä¢ Keep your admin credentials secure")
            print("   ‚Ä¢ Consider changing the password periodically")
            print("   ‚Ä¢ Do not share admin access with unauthorized users")
            return True
        else:
            print("\n‚ö†Ô∏è  Admin user created but login test failed.")
            print("You may need to check the authentication configuration.")
            print("The user was created successfully in the database.")
            return True  # User was created, so partially successful
    else:
        print("\n‚ùå SETUP FAILED!")
        print("Could not create admin user.")
        return False

async def main():
    """Main function with improved user interface"""
    print("üîß ESAL Platform Admin User Management System")
    print("=" * 60)
    print("This tool creates admin users with full system authentication.")
    print("Admin users will have complete access to:")
    print("   ‚Ä¢ Admin Portal Dashboard")
    print("   ‚Ä¢ User Management")
    print("   ‚Ä¢ System Configuration")
    print("   ‚Ä¢ Analytics & Reports")
    print("   ‚Ä¢ Platform Settings")
    print()
    print("Choose an option:")
    print("1. üÜï Create a new admin user (recommended)")
    print("2. üîÑ Create multiple predefined admin users")
    print("3. ‚ùå Exit")
    print()
    
    while True:
        choice = input("Enter your choice (1, 2, or 3): ").strip()
        
        if choice == "1":
            print("\n" + "üÜï" * 20)
            success = await create_single_admin()
            break
        elif choice == "2":
            print("\n" + "üîÑ" * 20)
            print("‚ö†Ô∏è  This will create multiple predefined admin accounts.")
            confirm = input("Are you sure you want to continue? (y/n): ").strip().lower()
            if confirm in ['y', 'yes']:
                success = await create_multiple_admins()
            else:
                print("‚ùå Operation cancelled.")
                success = False
            break
        elif choice == "3":
            print("üëã Goodbye!")
            return True
        else:
            print("‚ùå Invalid choice! Please enter 1, 2, or 3.")
            continue
    
    return success

if __name__ == "__main__":
    try:
        print("üöÄ Starting ESAL Platform Admin User Management System...")
        print("‚ö° Checking system requirements...")
        
        # Quick environment check
        if not os.path.exists('.env'):
            print("‚ö†Ô∏è  Warning: .env file not found in current directory")
            print("   Make sure you're running this from the API directory")
            print("   and that your .env file contains SUPABASE configuration")
        
        success = asyncio.run(main())
        
        if success:
            print("\n" + "üéâ" * 20)
            print("‚úÖ ADMIN USER MANAGEMENT COMPLETED SUCCESSFULLY!")
            print("üîê Your admin user is ready with full system authentication")
            print("üöÄ Next steps:")
            print("   1. Start the admin portal: http://localhost:3004")
            print("   2. Log in with your admin credentials")
            print("   3. Explore the admin dashboard")
            print("   4. Manage users and platform settings")
            print()
            print("üìö For help with the admin portal, see:")
            print("   ‚Ä¢ Admin documentation in /docs/admin/")
            print("   ‚Ä¢ Platform startup guide: PLATFORM_STARTUP.md")
            print("=" * 60)
            sys.exit(0)
        else:
            print("\n" + "‚ùå" * 20)
            print("‚ùå ADMIN USER MANAGEMENT FAILED!")
            print("üîß Troubleshooting steps:")
            print("   1. Check your .env file for correct SUPABASE configuration")
            print("   2. Ensure the API server dependencies are installed")
            print("   3. Verify Supabase connection and service key permissions")
            print("   4. Check the logs above for specific error details")
            print()
            print("üìû Need help? Check the documentation or contact support.")
            print("=" * 60)
            sys.exit(1)
            
    except KeyboardInterrupt:
        print("\n\n‚èπÔ∏è  Operation cancelled by user.")
        print("üëã Goodbye!")
        sys.exit(0)
    except Exception as e:
        print(f"\n‚ùå Unexpected error: {e}")
        import traceback
        traceback.print_exc()
        print("\nüîß Please check your setup and try again.")
        sys.exit(1)
