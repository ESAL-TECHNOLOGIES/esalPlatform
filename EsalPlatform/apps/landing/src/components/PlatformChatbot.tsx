import React, { useState, useRef, useEffect } from 'react';
import { MessageCircle, X, Send, Bot, User, Loader2, Zap, Brain, Sparkles } from 'lucide-react';

interface Message {
  id: string;
  content: string;
  isUser: boolean;
  timestamp: Date;
}

interface ChatbotProps {
  apiUrl?: string;
}

const PlatformChatbot: React.FC<ChatbotProps> = ({ 
  apiUrl = import.meta.env.VITE_API_URL || "http://localhost:8000" 
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const [messages, setMessages] = useState<Message[]>([
    {
      id: '1',
      content: "Hi! I'm the ESAL Platform assistant. I can help you understand how our platform works, including our AI matchmaking system, portal features, and how to get started. What would you like to know?",
      isUser: false,
      timestamp: new Date()
    }
  ]);
  const [inputValue, setInputValue] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  };

  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  const generateBotResponse = async (userMessage: string): Promise<string> => {
    const lowerMessage = userMessage.toLowerCase();
    
    // Knowledge base about ESAL Platform
    const responses = {
      // Platform overview
      'what is esal platform': `ESAL Platform is a comprehensive entrepreneurship and innovation platform that connects innovators, investors, and entrepreneurship hubs in a unified ecosystem. 

üöÄ **Key Features:**
‚Ä¢ **Multi-Portal System**: Specialized interfaces for Innovators, Investors, Hubs, and Admins
‚Ä¢ **AI-Powered Matching**: Advanced algorithms to connect startups with the right investors
‚Ä¢ **Idea Development Tools**: AI-assisted pitch generation and improvement
‚Ä¢ **Analytics & Insights**: Comprehensive tracking and performance metrics

ESAL stands for "Entidades Sin √Ånimo de Lucro" (Non-profit Organizations) and serves the entire entrepreneurship ecosystem.`,

      // AI Matchmaking
      'ai matchmaking': `Our AI Matchmaking system uses Google Gemini AI to intelligently connect investors with startups:

ü§ñ **How It Works:**
‚Ä¢ **Smart Analysis**: AI analyzes startup profiles including industry, stage, funding needs, and market potential
‚Ä¢ **Investor Preferences**: Matches based on investment criteria, risk tolerance, and portfolio preferences  
‚Ä¢ **Scoring Algorithm**: Provides match scores (0-100%) with detailed explanations
‚Ä¢ **Real-time Processing**: Fast analysis of hundreds of startups in seconds

üìä **Matching Factors:**
‚Ä¢ Industry alignment (30%)
‚Ä¢ Development stage (25%) 
‚Ä¢ Market opportunity (20%)
‚Ä¢ Risk-return profile (15%)
‚Ä¢ Geographic preferences (10%)

The AI provides fallback scoring when needed and explains why specific matches are recommended!`,

      'how does ai work': `Our AI system is powered by Google Gemini and provides several key services:

üß† **AI Capabilities:**
‚Ä¢ **Idea Generation**: Creates detailed startup ideas based on your interests and skills
‚Ä¢ **Pitch Optimization**: Improves existing business ideas and pitches
‚Ä¢ **Idea Evaluation**: Scores and provides feedback on startup concepts (0-10 scale)
‚Ä¢ **Strategic Recommendations**: Offers personalized business development advice
‚Ä¢ **Investor Matching**: Connects startups with compatible investors

‚ö° **AI Features:**
‚Ä¢ Natural language processing for better understanding
‚Ä¢ Real-time analysis and feedback
‚Ä¢ Confidence scoring for transparency
‚Ä¢ Fallback systems for reliability
‚Ä¢ Continuous learning from interactions`,

      // Platform portals
      'portals': `ESAL Platform has specialized portals for different user types:

üéØ **Innovator Portal** (Port 3001)
‚Ä¢ Submit and manage startup ideas
‚Ä¢ AI-powered idea generation and improvement
‚Ä¢ Analytics and performance tracking
‚Ä¢ Progress visualization

üí∞ **Investor Portal** (Port 3002)  
‚Ä¢ Browse curated investment opportunities
‚Ä¢ AI-powered startup matching
‚Ä¢ Portfolio management tools
‚Ä¢ Due diligence resources

üè¢ **Hub Portal** (Port 3003)
‚Ä¢ Manage startup cohorts and programs
‚Ä¢ Event planning and coordination
‚Ä¢ Member management system
‚Ä¢ Resource allocation tools

üõ†Ô∏è **Admin Portal** (Port 3004)
‚Ä¢ Platform-wide management
‚Ä¢ User administration
‚Ä¢ Analytics and reporting
‚Ä¢ System configuration

üåê **Landing Page** (Port 3000)
‚Ä¢ Public information and onboarding
‚Ä¢ Portal selection and access
‚Ä¢ Platform overview`,

      // Getting started
      'get started': `Here's how to get started with ESAL Platform:

1Ô∏è‚É£ **Choose Your Role:**
‚Ä¢ **Innovator**: Submit ideas, get AI feedback, connect with investors
‚Ä¢ **Investor**: Browse opportunities, use AI matching, manage portfolio  
‚Ä¢ **Hub Manager**: Manage programs, coordinate events, track member progress
‚Ä¢ **Admin**: Oversee platform operations and user management

2Ô∏è‚É£ **Access Your Portal:**
‚Ä¢ Visit the main landing page
‚Ä¢ Click "Join as [Your Role]"
‚Ä¢ Complete registration
‚Ä¢ Start exploring features

3Ô∏è‚É£ **Key First Steps:**
‚Ä¢ **Innovators**: Submit your first idea, try AI generation
‚Ä¢ **Investors**: Set preferences, run AI matching
‚Ä¢ **Hubs**: Add programs, import member data
‚Ä¢ **Admins**: Review system status, configure settings

Need help with anything specific? Just ask!`,

      // Technical details
      'technology': `ESAL Platform is built with modern, scalable technologies:

üèóÔ∏è **Architecture:**
‚Ä¢ **Frontend**: React 18 + TypeScript + Vite for fast development
‚Ä¢ **Backend**: FastAPI (Python) for high-performance APIs
‚Ä¢ **Database**: Supabase (PostgreSQL) with real-time features
‚Ä¢ **AI**: Google Gemini AI for intelligent features
‚Ä¢ **Styling**: Tailwind CSS for modern, responsive design

üõ°Ô∏è **Security:**
‚Ä¢ JWT-based authentication
‚Ä¢ Role-based access control
‚Ä¢ Supabase integration for user management
‚Ä¢ Input validation and SQL injection protection

‚ö° **Performance:**
‚Ä¢ Code splitting and lazy loading
‚Ä¢ Optimized bundle sizes
‚Ä¢ CDN distribution ready
‚Ä¢ Real-time updates via WebSocket`,

      // Default responses
      'default': `I'm here to help you learn about the ESAL Platform! You can ask me about:

üí° **Platform Features:**
‚Ä¢ What is ESAL Platform and how it works
‚Ä¢ AI matchmaking and how it connects investors with startups
‚Ä¢ Different portals (Innovator, Investor, Hub, Admin)
‚Ä¢ Getting started and registration process

ü§ñ **AI Capabilities:**
‚Ä¢ How our AI generates and improves startup ideas
‚Ä¢ AI-powered investor matching algorithm
‚Ä¢ Scoring and evaluation systems
‚Ä¢ Technology stack and architecture

üìö **General Information:**
‚Ä¢ Platform benefits and success stories
‚Ä¢ Technical specifications
‚Ä¢ Support and documentation

What would you like to know more about?`
    };

    // Check for specific topics
    if (lowerMessage.includes('what is esal') || lowerMessage.includes('esal platform')) {
      return responses['what is esal platform'];
    }
    if (lowerMessage.includes('ai match') || lowerMessage.includes('matchmaking')) {
      return responses['ai matchmaking'];
    }
    if (lowerMessage.includes('ai work') || lowerMessage.includes('how does ai')) {
      return responses['how does ai work'];
    }
    if (lowerMessage.includes('portal') || lowerMessage.includes('interface')) {
      return responses['portals'];
    }
    if (lowerMessage.includes('get started') || lowerMessage.includes('how to start') || lowerMessage.includes('begin')) {
      return responses['get started'];
    }
    if (lowerMessage.includes('technology') || lowerMessage.includes('tech stack') || lowerMessage.includes('architecture')) {
      return responses['technology'];
    }

    // Specific feature questions
    if (lowerMessage.includes('innovator')) {
      return `The **Innovator Portal** is designed for entrepreneurs and startup founders:

üöÄ **Key Features:**
‚Ä¢ **Idea Submission**: Upload and manage your startup concepts
‚Ä¢ **AI Assistance**: Generate new ideas or improve existing ones using Gemini AI
‚Ä¢ **Pitch Development**: Get AI feedback and scoring (0-10 scale)
‚Ä¢ **Analytics Dashboard**: Track views, investor interest, and performance metrics
‚Ä¢ **Progress Tracking**: Monitor your startup development journey

üí° **AI Tools for Innovators:**
‚Ä¢ Idea generation based on your skills and interests
‚Ä¢ Idea evaluation with detailed feedback
‚Ä¢ Fine-tuning suggestions for specific aspects
‚Ä¢ Strategic recommendations for growth

Ready to submit your first startup idea? Access the Innovator Portal to get started!`;
    }

    if (lowerMessage.includes('investor')) {
      return `The **Investor Portal** helps investors discover and evaluate opportunities:

üí∞ **Core Features:**
‚Ä¢ **Smart Discovery**: Browse startups with advanced filtering
‚Ä¢ **AI Matching**: Get personalized startup recommendations based on your preferences
‚Ä¢ **Portfolio Management**: Track investments and performance
‚Ä¢ **Due Diligence**: Access detailed startup information and analytics

üéØ **AI Matching Process:**
1. Set your investment preferences (industries, stages, funding range, risk tolerance)
2. AI analyzes all available startups against your criteria
3. Receive ranked matches with explanations and confidence scores
4. Express interest in promising opportunities

The AI considers industry alignment, development stage, market opportunity, and risk profile to find your perfect matches!`;
    }

    if (lowerMessage.includes('hub')) {
      return `The **Hub Portal** serves entrepreneurship hubs, accelerators, and incubators:

üè¢ **Management Tools:**
‚Ä¢ **Cohort Management**: Organize and track startup batches
‚Ä¢ **Member Coordination**: Manage entrepreneurs, mentors, and staff
‚Ä¢ **Event Planning**: Schedule and coordinate programs and events
‚Ä¢ **Resource Allocation**: Track capacity and resource usage
‚Ä¢ **Progress Monitoring**: Analyze startup development and success rates

üìä **Analytics Features:**
‚Ä¢ Hub performance metrics
‚Ä¢ Member engagement tracking
‚Ä¢ Program effectiveness analysis
‚Ä¢ Success rate monitoring

Perfect for accelerators, incubators, and innovation hubs looking to streamline operations!`;
    }

    if (lowerMessage.includes('admin')) {
      return `The **Admin Portal** provides comprehensive platform management:

üõ†Ô∏è **Administrative Control:**
‚Ä¢ **User Management**: Manage all platform users and roles
‚Ä¢ **Portal Control**: Start, stop, and monitor all platform services
‚Ä¢ **Analytics Dashboard**: Platform-wide usage and performance metrics
‚Ä¢ **Content Moderation**: Review and approve user submissions
‚Ä¢ **System Configuration**: Platform settings and feature toggles

üìà **Monitoring & Insights:**
‚Ä¢ Real-time system health checks
‚Ä¢ User engagement analytics
‚Ä¢ Performance optimization tools
‚Ä¢ Security audit logs

Designed for platform administrators who need complete oversight and control!`;
    }

    // Funding and business model questions
    if (lowerMessage.includes('funding') || lowerMessage.includes('investment') || lowerMessage.includes('money')) {
      return `ESAL Platform facilitates connections between startups seeking funding and investors:

üí∏ **For Startups:**
‚Ä¢ Specify funding needs and stage in your profile
‚Ä¢ Get matched with investors interested in your industry and stage
‚Ä¢ Showcase traction, team, and market opportunity
‚Ä¢ Receive feedback and interest from potential investors

üéØ **For Investors:**
‚Ä¢ Set investment criteria (amount, stage, industry, risk tolerance)
‚Ä¢ Use AI matching to find startups that fit your portfolio
‚Ä¢ Filter by funding requirements and development stage
‚Ä¢ Track opportunities and manage deal flow

The AI considers funding alignment as a key matching factor, ensuring startups are paired with investors who can meet their capital needs!`;
    }

    // Success and benefits
    if (lowerMessage.includes('benefit') || lowerMessage.includes('success') || lowerMessage.includes('why use')) {
      return `Here are the key benefits of using ESAL Platform:

üöÄ **For Innovators:**
‚Ä¢ AI-powered idea development and improvement
‚Ä¢ Access to relevant investors through smart matching
‚Ä¢ Professional pitch development tools
‚Ä¢ Analytics to track progress and interest

üí∞ **For Investors:**
‚Ä¢ Curated, high-quality startup opportunities
‚Ä¢ AI-driven matching saves time and improves deal flow
‚Ä¢ Comprehensive startup analytics and due diligence data
‚Ä¢ Portfolio management and tracking tools

üè¢ **For Hubs:**
‚Ä¢ Streamlined program and cohort management
‚Ä¢ Better tracking of member progress and outcomes
‚Ä¢ Event coordination and resource optimization
‚Ä¢ Data-driven insights for program improvement

üåü **Platform-Wide Benefits:**
‚Ä¢ Reduced friction in the entrepreneurship ecosystem
‚Ä¢ Better quality matches between stakeholders
‚Ä¢ AI assistance for better decision-making
‚Ä¢ Centralized platform for all innovation activities`;
    }

    // Help and support
    if (lowerMessage.includes('help') || lowerMessage.includes('support') || lowerMessage.includes('problem')) {
      return `I'm here to help! Here are ways to get support:

ü§ñ **Chat with Me:**
Ask about platform features, AI capabilities, getting started, or any general questions

üìö **Documentation:**
‚Ä¢ Comprehensive guides for each portal
‚Ä¢ API documentation for developers
‚Ä¢ Architecture and technical details
‚Ä¢ Deployment and setup instructions

üöÄ **Getting Started:**
‚Ä¢ Choose your role and access the appropriate portal
‚Ä¢ Follow the onboarding process
‚Ä¢ Start with basic features and explore advanced tools
‚Ä¢ Use AI assistance for guidance

‚ùì **Common Questions:**
‚Ä¢ "How does AI matchmaking work?"
‚Ä¢ "What portal should I use?"
‚Ä¢ "How do I submit my startup idea?"
‚Ä¢ "How do I find investors?"

What specific help do you need?`;
    }

    // Try Gemini AI for more complex questions
    try {
      const response = await fetch(`${apiUrl}/api/v1/chat/platform-assistant`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: userMessage,
          context: 'platform_assistance'
        }),
      });

      if (response.ok) {
        const data = await response.json();
        return data.response || responses['default'];
      }
    } catch (error) {
      console.log('AI service unavailable, using fallback responses');
    }

    return responses['default'];
  };
  const handleSendMessage = async () => {
    if (!inputValue.trim() || isLoading) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      content: inputValue,
      isUser: true,
      timestamp: new Date()
    };

    setMessages(prev => [...prev, userMessage]);
    const messageToSend = inputValue;
    setInputValue('');
    setIsLoading(true);

    try {
      const botResponse = await generateBotResponse(messageToSend);
      
      const botMessage: Message = {
        id: (Date.now() + 1).toString(),
        content: botResponse,
        isUser: false,
        timestamp: new Date()
      };

      setMessages(prev => [...prev, botMessage]);
    } catch (error) {
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        content: "I'm sorry, I'm having trouble right now. Please try asking about ESAL Platform features, AI matchmaking, or how to get started!",
        isUser: false,
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsLoading(false);
    }
  };
  const handleKeyPress = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  const handleQuickAction = (message: string) => {
    if (isLoading) return;
    setInputValue(message);
    // Auto-send the message after a short delay to show it was clicked
    setTimeout(() => {
      if (!isLoading) {
        handleSendMessage();
      }
    }, 100);
  };

  const formatMessage = (content: string) => {
    // Convert markdown-like formatting to HTML
    return content
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/‚Ä¢/g, '‚Ä¢')
      .replace(/\n/g, '<br />');
  };
  return (
    <>
      {/* Floating Chat Button */}
      {!isOpen && (
        <button
          onClick={() => setIsOpen(true)}
          className="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 bg-gradient-to-r from-purple-600 to-blue-600 text-white p-3 sm:p-4 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 z-50 group"
          aria-label="Open chat assistant"
        >
          <div className="relative">
            <Bot size={20} className="sm:w-6 sm:h-6" />
            <Sparkles size={12} className="absolute -top-1 -right-1 text-yellow-300 animate-pulse" />
          </div>
          <div className="absolute -top-12 right-0 bg-gray-800 text-white px-3 py-1 rounded-lg text-xs sm:text-sm opacity-0 group-hover:opacity-100 transition-opacity duration-300 whitespace-nowrap pointer-events-none">
            Ask about ESAL Platform
          </div>
        </button>
      )}

      {/* Chat Window */}
      {isOpen && (
        <div className="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 w-[calc(100vw-2rem)] max-w-sm sm:w-96 h-[70vh] sm:h-[500px] bg-white rounded-lg shadow-2xl border border-gray-200 z-50 flex flex-col">
          {/* Header */}
          <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-3 sm:p-4 rounded-t-lg flex items-center justify-between">
            <div className="flex items-center space-x-2">
              <div className="relative">
                <Bot size={18} className="sm:w-5 sm:h-5" />
                <Zap size={10} className="absolute -bottom-1 -right-1 text-yellow-300" />
              </div>
              <div>
                <span className="font-semibold text-sm sm:text-base">ESAL Assistant</span>
                <div className="flex items-center space-x-1 text-xs opacity-90">
                  <Brain size={12} />
                  <span>AI-Powered</span>
                </div>
              </div>
            </div>
            <button
              onClick={() => setIsOpen(false)}
              className="hover:bg-white/20 p-1 rounded transition-colors"
              aria-label="Close chat"
            >
              <X size={18} className="sm:w-5 sm:h-5" />
            </button>
          </div>

          {/* Messages */}
          <div className="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 sm:space-y-4">
            {messages.map((message) => (
              <div
                key={message.id}
                className={`flex ${message.isUser ? 'justify-end' : 'justify-start'}`}
              >
                <div
                  className={`max-w-[85%] sm:max-w-[80%] p-2 sm:p-3 rounded-lg ${
                    message.isUser
                      ? 'bg-blue-600 text-white rounded-br-sm'
                      : 'bg-gray-100 text-gray-800 rounded-bl-sm'
                  }`}
                >
                  <div className="flex items-start space-x-2">
                    {!message.isUser && (
                      <div className="flex-shrink-0 mt-0.5">
                        <div className="relative">
                          <Bot size={14} className="sm:w-4 sm:h-4 text-purple-600" />
                          <Sparkles size={8} className="absolute -top-1 -right-1 text-blue-500" />
                        </div>
                      </div>
                    )}
                    <div 
                      className="text-xs sm:text-sm leading-relaxed flex-1"
                      dangerouslySetInnerHTML={{ 
                        __html: formatMessage(message.content) 
                      }}
                    />
                    {message.isUser && (
                      <div className="flex-shrink-0 mt-0.5">
                        <User size={14} className="sm:w-4 sm:h-4" />
                      </div>
                    )}
                  </div>
                </div>
              </div>
            ))}
            
            {isLoading && (
              <div className="flex justify-start">
                <div className="bg-gray-100 text-gray-800 p-2 sm:p-3 rounded-lg rounded-bl-sm">
                  <div className="flex items-center space-x-2">
                    <div className="relative">
                      <Bot size={14} className="sm:w-4 sm:h-4 text-purple-600" />
                      <Brain size={8} className="absolute -top-1 -right-1 text-blue-500 animate-pulse" />
                    </div>
                    <Loader2 size={14} className="sm:w-4 sm:h-4 animate-spin text-purple-600" />
                    <span className="text-xs sm:text-sm text-gray-600">Thinking...</span>
                  </div>
                </div>
              </div>
            )}
            <div ref={messagesEndRef} />
          </div>

          {/* Input */}
          <div className="p-3 sm:p-4 border-t border-gray-200">
            <div className="flex space-x-2">
              <input
                type="text"
                value={inputValue}
                onChange={(e) => setInputValue(e.target.value)}
                onKeyPress={handleKeyPress}
                placeholder="Ask about ESAL Platform..."
                className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent text-xs sm:text-sm"
                disabled={isLoading}
              />
              <button
                onClick={handleSendMessage}
                disabled={!inputValue.trim() || isLoading}
                className="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-2 rounded-lg hover:from-purple-700 hover:to-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 flex-shrink-0"
                aria-label="Send message"
              >
                <Send size={14} className="sm:w-4 sm:h-4" />
              </button>
            </div>
              {/* Quick action buttons for mobile */}
            <div className="mt-2 sm:mt-3 flex flex-wrap gap-1 sm:gap-2">
              <button
                onClick={() => handleQuickAction("What is ESAL Platform?")}
                className="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition-colors"
                disabled={isLoading}
              >
                What is ESAL?
              </button>
              <button
                onClick={() => handleQuickAction("How does AI matchmaking work?")}
                className="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors"
                disabled={isLoading}
              >
                AI Matching
              </button>
              <button
                onClick={() => handleQuickAction("How to get started?")}
                className="px-2 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors"
                disabled={isLoading}
              >
                Get Started
              </button>
            </div>
          </div>
        </div>
      )}
    </>
  );
};

export default PlatformChatbot;
